namespace MagicOnion.Client.SourceGenerator.CodeGen.MemoryPack;

internal class MemoryPackFormatterRegistrationGenerator : ISerializerFormatterGenerator
{
    public string Build(GenerationContext generationContext, SerializationFormatterCodeGenContext ctx)
    {
        EmitPreamble(generationContext, ctx);
        EmitBody(generationContext, ctx);
        EmitPostscript(generationContext, ctx);

        return ctx.GetWrittenText();
    }

    static void EmitPreamble(GenerationContext generationContext, SerializationFormatterCodeGenContext ctx)
    {
        ctx.TextWriter.WriteLine("""
            // <auto-generated />
            #pragma warning disable CS0618 // 'member' is obsolete: 'text'
            #pragma warning disable CS0612 // 'member' is obsolete
            #pragma warning disable CS8019 // Unnecessary using directive.

            """);
    }

    static void EmitBody(GenerationContext generationContext, SerializationFormatterCodeGenContext ctx)
    {
        if (!string.IsNullOrEmpty(generationContext.Namespace))
        {
            ctx.TextWriter.WriteLine($$"""
            namespace {{generationContext.Namespace}}
            {
            """);
        }
        ctx.TextWriter.WriteLine($$"""
                using global::System;
                using global::MemoryPack;
            """);

        EmitRegister(generationContext, ctx);

        if (!string.IsNullOrEmpty(generationContext.Namespace))
        {
            ctx.TextWriter.WriteLine($$"""
            }
            """);
        }
    }

    static void EmitRegister(GenerationContext generationContext, SerializationFormatterCodeGenContext ctx)
    {
        ctx.TextWriter.WriteLine($$"""
                partial class {{generationContext.InitializerPartialTypeName}}
                {
                    /// <summary>
                    /// Registers the generated MemoryPackFormatters.
                    /// </summary>
                    public static void RegisterMemoryPackFormatters()
                    {
            """);
        foreach (var (resolverInfo, index) in ctx.FormatterRegistrations.Select((x, i) => (x, i)))
        {
            ctx.TextWriter.WriteLine($$"""
                        global::MemoryPack.MemoryPackFormatterProvider.Register(new {{(resolverInfo.FormatterName.StartsWith("global::") || string.IsNullOrWhiteSpace(ctx.FormatterNamespace) ? "" : ctx.FormatterNamespace + ".") + resolverInfo.FormatterName}}{{resolverInfo.FormatterConstructorArgs}});
            """);
        }
        ctx.TextWriter.WriteLine($$"""
                    }
                }
            """);
    }

    static void EmitPostscript(GenerationContext generationContext, SerializationFormatterCodeGenContext ctx)
    {
    }
}
